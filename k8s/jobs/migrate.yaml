apiVersion: batch/v1
kind: Job
metadata:
  name: db-migrate
  labels:
    app: db-migrate
spec:
  template:
    spec:
      containers:
      - name: migrate
        image: arigaio/atlas:latest
        command:
          - atlas
          - migrate
          - apply
          - --dir
          - file:///migrations
          - --url
          - $(DATABASE_URL)
        envFrom:
        - secretRef:
            name: app-secrets
        volumeMounts:
        - name: migrations
          mountPath: /migrations
      volumes:
      - name: migrations
        configMap:
          name: db-migrations
      restartPolicy: Never
  backoffLimit: 3
