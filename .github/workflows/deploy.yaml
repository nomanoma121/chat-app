name: Deploy to Server
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  ORG: nomanoma121
  APP: chat-app

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      sha_tag: ${{ steps.meta.outputs.SHA_TAG }}
    steps:
      - name: Set tags
        id: meta
        run: |
          SHA_TAG=${GITHUB_SHA::12}
          echo "SHA_TAG=$SHA_TAG" >> $GITHUB_OUTPUT

  build-frontend:
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Buildx setup
        uses: docker/setup-buildx-action@v3

      - name: Build & Push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./client
          build-args: |
            VITE_API_BASE_URL=${{ vars.API_BASE_URL }}
            VITE_CLIENT_BASE_URL=${{ vars.CLIENT_BASE_URL }}
            VITE_WS_BASE_URL=${{ vars.WS_BASE_URL }}
            VITE_MEDIA_BASE_URL=${{ vars.MEDIA_BASE_URL }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.ORG }}/${{ env.APP }}-frontend:latest
            ${{ env.REGISTRY }}/${{ env.ORG }}/${{ env.APP }}-frontend:${{ needs.prepare.outputs.sha_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-backend:
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: [user, guild, message, realtime, media, api-gateway]
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Buildx setup
        uses: docker/setup-buildx-action@v3

      - name: Build & Push ${{ matrix.service }}
        uses: docker/build-push-action@v6
        with:
          context: ./server
          build-args: |
            SERVICE_NAME=${{ matrix.service }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.ORG }}/${{ env.APP }}-${{ matrix.service }}:latest
            ${{ env.REGISTRY }}/${{ env.ORG }}/${{ env.APP }}-${{ matrix.service }}:${{ needs.prepare.outputs.sha_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: [prepare, build-frontend, build-backend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cloudflared
        run: |
          latest_version=$(curl -s https://api.github.com/repos/cloudflare/cloudflared/releases/latest | jq -r '.tag_name')
          mkdir -p /tmp/cloudflared
          curl -sL -o /tmp/cloudflared/cloudflared https://github.com/cloudflare/cloudflared/releases/download/$latest_version/cloudflared-linux-amd64
          chmod +x /tmp/cloudflared/cloudflared
          /tmp/cloudflared/cloudflared --version

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Deploy via SSH
        env:
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SHA_TAG: ${{ needs.prepare.outputs.sha_tag }}
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ProxyCommand="/tmp/cloudflared/cloudflared access ssh --id $CF_ACCESS_CLIENT_ID --secret $CF_ACCESS_CLIENT_SECRET --hostname %h" $SSH_USER@$SSH_HOST << EOF
            set -e
            echo "Pulling latest images with version: $SHA_TAG"
            export ORG=nomanoma121
            export APP=chat-app
            export VERSION=$SHA_TAG
            docker compose -f ~/chat-app/docker-compose.prod.yml pull
            docker compose -f ~/chat-app/docker-compose.prod.yml up -d
            echo "Cleaning up unused images..."
            docker image prune -f
            echo "Deployment completed."
          EOF
